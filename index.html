<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>Happy Birthday â¤ï¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #05010a;
  font-family: "Segoe UI", "PingFang SC", sans-serif;
}
canvas {
  position: fixed;
  top: 0;
  left: 0;
}
#debug {
  position: fixed;
  top: 10px;
  left: 10px;
  color: #fff;
  font-size: 12px;
  opacity: 0.7;
}
#hint {
  position: fixed;
  bottom: 20px;
  width: 100%;
  text-align: center;
  color: rgba(255,255,255,0.8);
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>
<div id="debug">ç­‰å¾…æ‰‹åŠ¿è¯†åˆ«...</div>
<div id="hint">ğŸ™ åŒæ‰‹åˆå â†’ ç”Ÿæ—¥ç¥ç¦ ï½œ âœ‹ å‘å¤–å±•å¼€ â†’ ğŸ‚</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const debug = document.getElementById("debug");

resize();
window.addEventListener("resize", resize);

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

/* ===== èƒŒæ™¯ç»˜åˆ¶ ===== */
function drawBackground() {
  const g = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, 0,
    canvas.width/2, canvas.height/2, canvas.width
  );
  g.addColorStop(0, "#1a0a2e");
  g.addColorStop(1, "#05010a");
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

/* ===== å…‰ç²’ ===== */
let particles = [];

class Particle {
  constructor(x, y) {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.tx = x;
    this.ty = y;
  }
  update() {
    this.x += (this.tx - this.x) * 0.08;
    this.y += (this.ty - this.y) * 0.08;
  }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = "rgba(255,200,255,0.9)";
    ctx.shadowBlur = 12;
    ctx.shadowColor = "#ffb3ff";
    ctx.arc(this.x, this.y, 2, 0, Math.PI*2);
    ctx.fill();
  }
}

/* ===== å½¢çŠ¶ç”Ÿæˆ ===== */
function shapeFromDraw(drawFn) {
  const off = document.createElement("canvas");
  off.width = canvas.width;
  off.height = canvas.height;
  const o = off.getContext("2d");
  drawFn(o);
  const data = o.getImageData(0,0,canvas.width,canvas.height).data;
  const pts = [];
  for(let y=0;y<canvas.height;y+=6){
    for(let x=0;x<canvas.width;x+=6){
      if(data[(y*canvas.width+x)*4+3]>150){
        pts.push({x,y});
      }
    }
  }
  return pts;
}

function birthdayText() {
  return shapeFromDraw(o=>{
    o.fillStyle="#fff";
    o.font="bold 120px Segoe UI";
    o.textAlign="center";
    o.textBaseline="middle";
    o.fillText("Happy Birthday",canvas.width/2,canvas.height/2);
  });
}

function cakeShape() {
  return shapeFromDraw(o=>{
    const cx=canvas.width/2, cy=canvas.height/2+50;
    o.fillStyle="#fff";
    o.fillRect(cx-120,cy,240,80);
    o.fillRect(cx-90,cy-60,180,60);
    o.beginPath();
    o.moveTo(cx,cy-100);
    o.lineTo(cx,cy-60);
    o.lineWidth=6;
    o.strokeStyle="#fff";
    o.stroke();
  });
}

function morph(shape) {
  particles = shape.map(p=>new Particle(p.x,p.y));
}

/* ===== åŠ¨ç”» ===== */
function animate(){
  drawBackground();
  particles.forEach(p=>{
    p.update();
    p.draw();
  });
  requestAnimationFrame(animate);
}
animate();

/* ===== æ‰‹åŠ¿è¯†åˆ« ===== */
let phase = "idle";
let smoothDist = null;

const video = document.createElement("video");
video.style.display="none";
document.body.appendChild(video);

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 2,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(res=>{
  if(res.multiHandLandmarks?.length===2){
    const a=res.multiHandLandmarks[0][0];
    const b=res.multiHandLandmarks[1][0];
    const d=Math.hypot(a.x-b.x,a.y-b.y);
    smoothDist = smoothDist ? smoothDist*0.8 + d*0.2 : d;

    debug.textContent = `åŒæ‰‹è·ç¦»ï¼š${smoothDist.toFixed(2)}`;

    if(smoothDist < 0.18 && phase!=="text"){
      phase="text";
      morph(birthdayText());
    }
    if(smoothDist > 0.45 && phase==="text"){
      phase="cake";
      morph(cakeShape());
    }
  } else {
    debug.textContent = "æœªæ£€æµ‹åˆ°åŒæ‰‹";
  }
});

const camera = new Camera(video,{
  onFrame:()=>hands.send({image:video}),
  width:640,
  height:480
});
camera.start();
</script>
</body>
</html>
