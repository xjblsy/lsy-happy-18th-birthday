<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>Happy Birthday â¤ï¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
#startBtn{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  padding: 16px 28px;
  font-size: 18px;
  border-radius: 40px;
  border: none;
  background: linear-gradient(135deg,#ff7ac8,#c77dff);
  color: white;
  cursor: pointer;
  z-index: 10;
}

html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #05010a;
  font-family: "Segoe UI","PingFang SC",sans-serif;
}
canvas { position: fixed; top: 0; left: 0; }

#debug {
  position: fixed;
  top: 10px;
  left: 10px;
  color: #fff;
  font-size: 12px;
  opacity: 0.8;
}
#hint {
  position: fixed;
  bottom: 20px;
  width: 100%;
  text-align: center;
  color: rgba(255,255,255,0.8);
}
</style>
</head>

<body>
<button id="startBtn">ç‚¹å‡»å¼€å§‹ç¥ç¦</button>
<canvas id="canvas"></canvas>
<div id="debug">ç­‰å¾…å¯åŠ¨â€¦</div>
<div id="hint">ğŸ™ åŒæ‰‹åˆå â†’ ç”Ÿæ—¥ç¥ç¦ ï½œ âœ‹ å‘å¤–å±•å¼€ â†’ ğŸ‚</div>

<script>
/* ===== Canvas ===== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const debug = document.getElementById("debug");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ===== Background ===== */
function drawBackground(){
  const g = ctx.createRadialGradient(
    canvas.width/2, canvas.height/2, 0,
    canvas.width/2, canvas.height/2, canvas.width
  );
  g.addColorStop(0,"#1a0a2e");
  g.addColorStop(1,"#05010a");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

/* ===== Particles ===== */
let particles = [];
class Particle{
  constructor(x,y){
    this.x=Math.random()*canvas.width;
    this.y=Math.random()*canvas.height;
    this.tx=x; this.ty=y;
  }
  update(){
    this.x+=(this.tx-this.x)*0.08;
    this.y+=(this.ty-this.y)*0.08;
  }
  draw(){
    ctx.beginPath();
    ctx.fillStyle="rgba(255,200,255,0.9)";
    ctx.shadowBlur=12;
    ctx.shadowColor="#ffb3ff";
    ctx.arc(this.x,this.y,2,0,Math.PI*2);
    ctx.fill();
  }
}

/* ===== Shapes ===== */
function shapeFromDraw(draw){
  const off=document.createElement("canvas");
  off.width=canvas.width;
  off.height=canvas.height;
  const o=off.getContext("2d");
  draw(o);
  const data=o.getImageData(0,0,off.width,off.height).data;
  const pts=[];
  for(let y=0;y<off.height;y+=6){
    for(let x=0;x<off.width;x+=6){
      if(data[(y*off.width+x)*4+3]>150) pts.push({x,y});
    }
  }
  return pts;
}

const birthdayText=()=>shapeFromDraw(o=>{
  o.fillStyle="#fff";
  o.font="bold 120px Segoe UI";
  o.textAlign="center";
  o.textBaseline="middle";
  o.fillText("Happy Birthday",canvas.width/2,canvas.height/2);
});

const cakeShape=()=>shapeFromDraw(o=>{
  const cx=canvas.width/2, cy=canvas.height/2+50;
  o.fillStyle="#fff";
  o.fillRect(cx-120,cy,240,80);
  o.fillRect(cx-90,cy-60,180,60);
  o.beginPath();
  o.moveTo(cx,cy-100);
  o.lineTo(cx,cy-60);
  o.lineWidth=6;
  o.strokeStyle="#fff";
  o.stroke();
});

function morph(shape){
  particles=shape.map(p=>new Particle(p.x,p.y));
}

/* ===== Animation ===== */
(function animate(){
  drawBackground();
  particles.forEach(p=>{p.update();p.draw();});
  requestAnimationFrame(animate);
})();

/* ===== MediaPipe ===== */
let phase="idle";
let closeCount=0;
let openCount=0;

const video=document.createElement("video");
video.setAttribute("playsinline","");
video.muted=true;
video.autoplay=true;
video.style.display="none";
document.body.appendChild(video);

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
});

hands.onResults(res=>{
  if(res.multiHandLandmarks?.length===2){
    const p1 = res.multiHandLandmarks[0][8]; // é£ŸæŒ‡æŒ‡å°–
    const p2 = res.multiHandLandmarks[1][8];
    const d = Math.hypot(p1.x - p2.x, p1.y - p2.y);

    debug.textContent = `æŒ‡å°–è·ç¦» ${d.toFixed(2)}`;

    if(d < 0.08){
      closeCount++;
      openCount = 0;
    } else if(d > 0.25){
      openCount++;
      closeCount = 0;
    } else {
      closeCount = openCount = 0;
    }

    if(closeCount > 6 && phase !== "text"){
      phase = "text";
      morph(birthdayText());
    }

    if(openCount > 6 && phase === "text"){
      phase = "cake";
      morph(cakeShape());
    }
  } else {
    debug.textContent = "è¯·åŒæ—¶ä¼¸å‡ºä¸¤åªæ‰‹";
    closeCount = openCount = 0;
  }
});

const camera=new Camera(video,{
  onFrame: async ()=>{ await hands.send({image:video}); },
  width:640,
  height:480
});

startBtn.onclick=async()=>{
  debug.textContent="å¯åŠ¨æ‘„åƒå¤´ä¸­â€¦";
  await camera.start();
  startBtn.style.display="none";
};
</script>
</body>
</html>
